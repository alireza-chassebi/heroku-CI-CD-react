language: generic
sudo: required

services: docker

before_install:
  # install heroku  cli
  - wget -qO- https://toolbelt.heroku.com/install.sh | sh
  - echo "$HEROKU_API_KEY" | docker login -u "$HEROKU_USERNAME" --password-stdin registry.heroku.com
  # build dev image
  - docker build -t alireza-chassebi/app-dev -f Dockerfile.dev .

script:
  # run test on dev container
  - docker run -e CI=true alireza-chassebi/app-dev npm run test
  # create prod image
  - docker build -t alireza-chassebi/app-prod .
  # tag image in the heroku registry repo
  - docker tag alireza-chassebi/app-prod registry.heroku.com/$HEROKU_APP/web

deploy:
  provider: script
  script:
    # push to heroku registry
    - docker push registry.heroku.com/$HEROKU_APP/web;
    - heroku container:release web --app $HEROKU_APP
  on:
    branch: master
